# BUD-10

## Account based quotas

`draft` `optional`

This BUD describes account-based quota management for blob storage services using Bitcoin Lightning Network payments. Servers MAY implement this API to provide quota-based access control and monetization.

## GET /payment - Get Payment Information

This endpoint returns the current payment configuration and pricing structure for the blob storage service.

### Request

```http
GET /payment HTTP/1.1
Host: blossom.example.com
```

### Response

The server MUST respond with a JSON object containing the payment configuration:

```json
{
  "unit": "GBSpace",
  "interval": {
    "month": 1
  },
  "cost": {
    "currency": "BTC", 
    "amount": 0.00000100
  }
}
```

**Fields:**
- `unit`: The billing unit, either `"GBSpace"` (storage) or `"GBEgress"` (bandwidth)
- `interval`: The billing period with one of:
  - `{"day": n}` - Daily billing for n days
  - `{"month": n}` - Monthly billing for n months  
  - `{"year": n}` - Yearly billing for n years
- `cost`: Payment amount per unit per interval
  - `currency`: Currency code (currently only `"BTC"` supported)
  - `amount`: Amount in BTC per unit

## POST /payment - Request Payment Invoice

This endpoint generates a Lightning Network payment request for purchasing storage quota.

### Request

The request MUST include a valid NIP-98 authorization event in the `Authorization` header.

```http
POST /payment HTTP/1.1
Host: blossom.example.com
Authorization: Nostr <base64-encoded-nip98-event>
Content-Type: application/json

{
  "units": 5.0,
  "quantity": 3
}
```

**Fields:**
- `units`: Number of billing units to purchase (e.g., GB of storage)
- `quantity`: Number of billing intervals (e.g., months)

### Response

On success, the server MUST respond with a Lightning payment request:

```json
{
  "pr": "lnbc1500n1pn2s39kpp5..."
}
```

**Fields:**
- `pr`: Lightning Network payment request (BOLT-11 invoice)

### Error Response

If the request is invalid or unauthorized:

```json
{
  "message": "Authentication required"
}
```

## GET /self - Get User Quota Information

This endpoint returns the current user's storage quota and payment status.

### Request

The request MUST include a valid NIP-98 authorization event in the `Authorization` header.

```http
GET /self HTTP/1.1
Host: blossom.example.com
Authorization: Nostr <base64-encoded-nip98-event>
```

### Response

The server MUST respond with a JSON object containing the user's quota information:

```json
{
  "pubkey": "npub1...",
  "quota": {
    "used": 2.5,
    "total": 10.0,
    "unit": "GBSpace"
  },
  "expires": 1735689600,
  "free_quota": 1.0
}
```

**Fields:**
- `pubkey`: The user's public key in npub format
- `quota`: Current quota status
  - `used`: Amount of quota currently consumed
  - `total`: Total quota available to the user
  - `unit`: The quota unit (e.g., `"GBSpace"` for storage)
- `expires`: Unix timestamp when the current quota expires
- `free_quota` (optional): Amount of free quota included in the total, if any

## Example Flow

1. Client requests payment information:
   ```http
   GET /payment
   ```

2. Server responds with pricing:
   ```json
   {
     "unit": "GBSpace",
     "interval": {"month": 1},
     "cost": {"currency": "BTC", "amount": 0.00000100}
   }
   ```

3. Client calculates cost (5 GB × 3 months × 100 sats = 1,500 sats) and requests invoice:
   ```http
   POST /payment
   Authorization: Nostr eyJ0eXAiOiJKV1Q...
   
   {
     "units": 5.0,
     "quantity": 3
   }
   ```

4. Server generates Lightning invoice and responds:
   ```json
   {
     "pr": "lnbc15u1pn2s39kpp5..."
   }
   ```

5. Client pays the Lightning invoice using their wallet

6. Server monitors Lightning Network for payment settlement and automatically extends the user's storage quota upon confirmation

## Implementation Notes

- Payment settlements MUST be monitored in real-time via Lightning Network
- User quotas SHOULD be updated immediately upon payment confirmation
- Servers MAY support fractional quota upgrades within billing periods
- Exchange rates for fiat currencies MAY be tracked but payments MUST be in BTC
- Servers MAY include free quota in the `/self` endpoint response to indicate any complimentary storage allocation